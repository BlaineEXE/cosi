# DO NOT EDIT! This file is generated by 'hack/gen-dockerfile.sh' from 'Dockerfile.in'

#
# BUILDER
#
FROM docker.io/library/golang:1.22 AS builder

WORKDIR /buildroot

# Cache deps before building and copying source, so that we don't need to re-download
# as much and so that source changes don't invalidate our downloaded layer.
COPY client/ client/
COPY proto/ proto/
COPY internal/ internal/

COPY sidecar/go.mod sidecar/go.mod
COPY sidecar/go.sum sidecar/go.sum

RUN cd sidecar && go mod download

COPY sidecar/cmd/ sidecar/cmd/
COPY sidecar/pkg/ sidecar/pkg/

WORKDIR /buildroot/sidecar

RUN CGO_ENABLED=0 go build -o /buildroot/artifacts/sidecar cmd/*.go


#
# FINAL IMAGE
#

# gcr.io is deprecated, but gcr.io/distroless/static is hosted by artifact hub with the gcr.io path.
# See: https://github.com/GoogleContainerTools/distroless/issues/1320
FROM gcr.io/distroless/static:nonroot

LABEL maintainers="Kubernetes Authors"
LABEL description="COSI sidecar"

LABEL org.opencontainers.image.title="COSI sidecar"
LABEL org.opencontainers.image.description="Container Object Storage Interface (COSI) sidecar"
LABEL org.opencontainers.image.source="https://github.com/kubernetes-sigs/container-object-storage-interface/sidecar"
LABEL org.opencontainers.image.licenses="APACHE-2.0"

WORKDIR /
COPY --from=builder /buildroot/artifacts/sidecar .
USER 65532:65532

ENTRYPOINT ["/sidecar"]
